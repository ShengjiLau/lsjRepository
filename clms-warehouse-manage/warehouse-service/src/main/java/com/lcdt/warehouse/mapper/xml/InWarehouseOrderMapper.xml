<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lcdt.warehouse.mapper.InWarehouseOrderMapper">
    <resultMap id="BaseResultMap" type="com.lcdt.warehouse.entity.InWarehouseOrder">
        <id column="inorder_id" jdbcType="BIGINT" property="inorderId"/>
        <result column="plan_id" jdbcType="BIGINT" property="planId"/>
        <result column="in_order_code" jdbcType="VARCHAR" property="inOrderCode"/>
        <result column="in_order_status" jdbcType="TINYINT" property="inOrderStatus"/>
        <result column="group_id" jdbcType="BIGINT" property="groupId"/>
        <result column="group_name" jdbcType="VARCHAR" property="groupName"/>
        <result column="purchase_code" jdbcType="VARCHAR" property="purchaseCode"/>
        <result column="customer_name" jdbcType="VARCHAR" property="customerName"/>
        <result column="customer_contact_name" jdbcType="VARCHAR" property="customerContactName"/>
        <result column="customer_contact_phone" jdbcType="VARCHAR" property="customerContactPhone"/>
        <result column="warehouse_id" jdbcType="BIGINT" property="warehouseId"/>
        <result column="warehouse_name" jdbcType="VARCHAR" property="warehouseName"/>
        <result column="storage_type" jdbcType="VARCHAR" property="storageType"/>
        <result column="storage_plan_time" jdbcType="TIMESTAMP" property="storagePlanTime"/>
        <result column="storage_time" jdbcType="TIMESTAMP" property="storageTime"/>
        <result column="storage_remark" jdbcType="VARCHAR" property="storageRemark"/>
        <result column="deliveryman_name" jdbcType="VARCHAR" property="deliverymanName"/>
        <result column="deliveryman_phone" jdbcType="VARCHAR" property="deliverymanPhone"/>
        <result column="deliveryman_linkman" jdbcType="VARCHAR" property="deliverymanLinkman"/>
        <result column="deliveryman_car" jdbcType="VARCHAR" property="deliverymanCar"/>
        <result column="attachments" jdbcType="VARCHAR" property="attachments"/>
        <result column="company_id" jdbcType="BIGINT" property="companyId"/>
        <result column="create_id" jdbcType="BIGINT" property="createId"/>
        <result column="create_name" jdbcType="VARCHAR" property="createName"/>
        <result column="create_date" jdbcType="TIMESTAMP" property="createDate"/>
        <result column="update_id" jdbcType="BIGINT" property="updateId"/>
        <result column="update_name" jdbcType="VARCHAR" property="updateName"/>
        <result column="update_date" jdbcType="TIMESTAMP" property="updateDate"/>
        <result column="is_deleted" jdbcType="BIT" property="isDeleted"/>
    </resultMap>

    <resultMap id="InWarehouseOrderDetailsMap" type="com.lcdt.warehouse.dto.InWarehouseOrderAddParamsDto" extends="BaseResultMap">
        <collection property="goodsInfoDtoList" column="inorder_id" ofType="com.lcdt.warehouse.dto.InorderGoodsInfoParamsDto" select="com.lcdt.warehouse.mapper.InorderGoodsInfoMapper.goodsDetail"/>
    </resultMap>

    <sql id="Base_Select_List" >
        inorder_id, plan_id, in_order_code, in_order_status, group_id, group_name,
        purchase_code, customer_name, customer_contact_name, customer_contact_phone, warehouse_id,
        warehouse_name, storage_type, storage_plan_time, storage_time, storage_remark, deliveryman_name,
        deliveryman_phone, deliveryman_linkman, deliveryman_car, attachments, company_id,
        create_id, create_name, create_date,is_deleted
    </sql>

    <sql id="Base_Select_Goods_List">
        g.goods_id, goods_name, goods_classify, goods_spec, goods_code, goods_barcode,
        goods_price, goods_batch, sub_item_id, min_unit, multi_unit
    </sql>
    <sql id="Base_Select_In_Goods_List">
        relation_id, oi.inorder_id, oi.goods_id, unit, unit_data, receivalbe_amount, batch,
        in_house_amount, in_house_price, damage, remark, stroge_location_id, stroge_location_code
    </sql>

    <insert id="insertInWarehouseOrder" parameterType="com.lcdt.warehouse.entity.InWarehouseOrder">
        <selectKey keyProperty="inorderId" order="AFTER" resultType="java.lang.Long">
            SELECT LAST_INSERT_ID()
        </selectKey>
        insert into in_warehouse_order (plan_id, in_order_code, in_order_status,
        group_id, group_name, purchase_code,
        customer_name, customer_contact_name, customer_contact_phone,
        warehouse_id, warehouse_name, storage_type,
        storage_plan_time, storage_time, storage_remark,
        deliveryman_name, deliveryman_phone, deliveryman_linkman,
        deliveryman_car, attachments, company_id,
        create_id, create_name, create_date,
        is_deleted)
        values (#{planId,jdbcType=BIGINT},
        <choose>
            <when test="planId!=null and planId!=''">
                F_IN_ORDER_CODE_BY_PLAN(#{inOrderCode,jdbcType=VARCHAR},#{planId,jdbcType=BIGINT})
            </when>
            <otherwise>
                F_IN_ORDER_CODE('IN')
            </otherwise>
        </choose>,
        #{inOrderStatus,jdbcType=TINYINT},
        #{groupId,jdbcType=BIGINT}, #{groupName,jdbcType=VARCHAR}, #{purchaseCode,jdbcType=VARCHAR},
        #{customerName,jdbcType=VARCHAR}, #{customerContactName,jdbcType=VARCHAR},
        #{customerContactPhone,jdbcType=VARCHAR},
        #{warehouseId,jdbcType=BIGINT}, #{warehouseName,jdbcType=VARCHAR}, #{storageType,jdbcType=VARCHAR},
        #{storagePlanTime,jdbcType=TIMESTAMP}, #{storageTime,jdbcType=TIMESTAMP}, #{storageRemark,jdbcType=VARCHAR},
        #{deliverymanName,jdbcType=VARCHAR}, #{deliverymanPhone,jdbcType=VARCHAR},
        #{deliverymanLinkman,jdbcType=VARCHAR},
        #{deliverymanCar,jdbcType=VARCHAR}, #{attachments,jdbcType=VARCHAR}, #{companyId,jdbcType=BIGINT},
        #{createId,jdbcType=BIGINT}, #{createName,jdbcType=VARCHAR},CURRENT_TIMESTAMP,
        0)
    </insert>

    <select id="selectByCondition" resultMap="InWarehouseOrderDetailsMap">
        SELECT <include refid="Base_Select_List"/>
        from in_warehouse_order
        <where>
            company_id= #{companyId,jdbcType=BIGINT}
        </where>
    </select>
</mapper>
