<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lcdt.warehouse.mapper.InventoryLogMapper">

    <resultMap id="BaseResultMap" type="com.lcdt.warehouse.entity.InventoryLog">
        <id column="log_id" jdbcType="BIGINT" property="logId" />
        <result column="goods_id" jdbcType="BIGINT" property="goodsId" />
        <result column="warehouse_id" jdbcType="BIGINT" property="warehouseId" />
        <result column="storage_location_code" jdbcType="VARCHAR" property="storageLocationCode" />
        <result column="log_time" jdbcType="TIMESTAMP" property="logTime" />
        <result column="current_invetory" jdbcType="INTEGER" property="currentInvetory" />
        <result column="change_num" jdbcType="REAL" property="changeNum" />
        <result column="business_no" jdbcType="VARCHAR" property="businessNo" />
        <result column="inventory_id" jdbcType="BIGINT" property="inventoryId" />
        <result column="type" jdbcType="INTEGER" property="type" />
        <result column="original_goods_id" jdbcType="BIGINT" property="originalGoodsId" />
        <result column="customer_id" jdbcType="BIGINT" property="customerId" />
        <result column="customer_name" jdbcType="VARCHAR" property="customerName" />
        <result column="storage_location_id" jdbcType="BIGINT" property="storageLocationId" />
        <result column="comment" jdbcType="VARCHAR" property="comment" />
        <result column="company_id" jdbcType="BIGINT" property="companyId" />
        <result column="log_no" jdbcType="VARCHAR" property="logNo" />
        <result column="batch" jdbcType="VARCHAR" property="batch" />
        <association property="goodsInfo" autoMapping="true" javaType="com.lcdt.warehouse.entity.GoodsInfo"></association>
        <association property="warehouse" column="warehouse_id"  javaType="com.lcdt.warehouse.entity.Warehouse" select="selectWareHouse"></association>
    </resultMap>

    <select id="selectWareHouse" resultMap="com.lcdt.warehouse.mapper.WarehousseMapper.BaseResultMap">
        select * from t_warehouse where wh_id = #{id}
    </select>

    <insert id="saveLog" parameterType="com.lcdt.warehouse.entity.InventoryLog">
        <selectKey keyProperty="inventoryId" order="AFTER" resultType="java.lang.Long">
            SELECT LAST_INSERT_ID()
        </selectKey>
        insert into inventory_log (log_id, goods_id, warehouse_id,
        storage_location_code,  current_invetory,
        change_num, business_no, type,
        original_goods_id, customer_id, customer_name,
        storage_location_id, comment, company_id,
        log_no, batch, order_id,inventory_id
        )
        values (#{logId,jdbcType=BIGINT}, #{goodsId,jdbcType=BIGINT}, #{warehouseId,jdbcType=BIGINT},
        #{storageLocationCode,jdbcType=VARCHAR}, #{currentInvetory,jdbcType=INTEGER},
        #{changeNum,jdbcType=REAL}, #{businessNo,jdbcType=VARCHAR}, #{type,jdbcType=INTEGER},
        #{originalGoodsId,jdbcType=BIGINT}, #{customerId,jdbcType=BIGINT}, #{customerName,jdbcType=VARCHAR},
        #{storageLocationId,jdbcType=BIGINT}, #{comment,jdbcType=VARCHAR}, #{companyId,jdbcType=BIGINT},
        INVENTORY_LOG_NO(), #{batch,jdbcType=VARCHAR}, #{orderId,jdbcType=BIGINT},#{inventoryId,jdbcType=BIGINT}
        )
    </insert>

    <select id="selectLogList" resultMap="BaseResultMap">
        SELECT * from inventory_log a left join goods_info b on
        a.goods_id = b.goods_id
        <where>
            <if test="companyId != null">
                a.company_id = #{companyId}
            </if>
            <if test="inventoryId != null">
                a.inventory_id = #{inventoryId}
            </if>

            <if test="type != null">
                and a.type = #{type}
            </if>
            <if test="customerId != null">
                and a.customer_id = #{customerId}
            </if>

            <if test="warehouseId != null">
                and a.warehouse_id = #{warehouseId}
            </if>

            <if test="storageLocationCode != null">
                and a.storage_location_code like CONCAT(CONCAT('%',#{storageLocationCode}),'%')
            </if>
            <if test="since != null">
                and a.log_time &gt;=  #{since}
            </if>
            <if test="until != null">
                and a.log_time &lt;= #{until}
            </if>
            <if test="goodsName != null">
                and b.goods_name like CONCAT(CONCAT('%',#{goodsName}),'%')
            </if>
            <if test="goodsbarcode != null">
                and b.goods_barcode like CONCAT(CONCAT('%',#{goodsbarcode}),'%')
            </if>
            <if test="businessNo != null ">
                and a.business_no like CONCAT(CONCAT('%',#{businessNo}),'%')
            </if>
        </where>
        order by log_time desc
    </select>

</mapper>
