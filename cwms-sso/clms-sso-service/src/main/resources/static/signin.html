<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <title>登录 | 大驼队cLMS协同物流管理系统</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="/asset/style/signin.css">
  </head>
  <body>
    <div class="page">
      <div class="signin-box">
      <div class="logo-box">
      </div>
      <div class="signin-form">
        <form id="signin-form" class="" action="/account/login" id="signin-form" method="post">
          <div class="form-row">
            <label for="username">手机号：</label>
            <div class="clms-input">
              <span>+86</span>
              <input type="text" name="username"  value="" >
            </div>
          </div>
          <div class="form-row">
            <label for="password">密码：</label>
            <div class="clms-input">
              <input  type="password" name="password" value="" >
            </div>
          </div>
          <div class="form-row">
            <label for="captchacode">验证码：</label>
            <div class="clms-input capcha_input">
              <input type="text" name="captchacode" value="" >
            </div>
            <div class="capcha_img">
              <img id="captchaimg" src="/auth/getcaptcha" alt="./public/vc.png" onclick="refreshCaptcha()"></a>            </div>
          </div>
          <div class="form-row login-btn-row" style="margin-top:32px;">
            <button type="submit" class="login-btn">
              登录
            </button>
          </div>
          <div class="form-row login-btn-row">
            <a href="#" class="primary-btn" onclick="register();">立即注册</a>
            <a href="" class="default-btn">忘记密码</a>
          </div>
        </form>
      </div>
    </div>
    </div>
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/jquery-validate/1.17.0/jquery.validate.min.js"></script>
    <script src="https://cdn.bootcss.com/jquery-validate/1.17.0/localization/messages_zh.min.js"></script>
    <script type="text/javascript">
        $().ready(function() {
            $("#signin-form").validate({
                rules:{     //配置验证规则，key就是被验证的dom对象，value就是调用验证的方法(也是json格式)
                    username:{
                        required:true,  //必填。如果验证方法不需要参数，则配置为true
                        rangelength:[6,12]
                    },
                    password:{
                        required:true,
                        rangelength:[6,12]
                    },
                    captchacode:{
                        required:true,
                        rangelength:[1,4],
                    }
                }
            });
        });

        //验证码
        var refreshCaptcha = function(){
            document.getElementById("captchaimg").src="/auth/getcaptcha?random=" + Math.random();
            return false;
        }


        //注册逻辑
        var register = function () {
            var hStr = window.location.href.split(":")[0];
            window.location.href = hStr+"://"+window.location.host+"/auth/register";
        }


        $.validator.setDefaults({
        submitHandler: function() {
            var form = document.getElementById("signin-form");
            var fd = new FormData(form);
            $.ajax({
                processData: false,
                contentType: false,
                type: 'POST',
                url: '/account/login',
                data: fd,
                success: function (data) {
                    var data = JSON.parse(data);
                    if (data.code == 0) {
                        if (data.hasOwnProperty("data")) {
                            var dataArray = data.data;
                            if (dataArray.length==0) { //没有企业关系
                                window.location.href = "/account/createcompany";
                            } else {
                                window.location.href = "/account/choosecompany";
                            }
                        }

                    }else{
                        alert(data.message)
                    }
                },
                error: function (data) {
                    var result = JSON.parse(data);
                    alert(result.message);
                },
            });

        }
      });




      </script>

  </body>
</html>
