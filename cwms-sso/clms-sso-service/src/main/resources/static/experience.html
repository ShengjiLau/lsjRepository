<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <title>体验 | 大驼队cLMS协同物流管理系统</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="/asset/style/style.css">
    <link rel="stylesheet" href="/asset/style/iconfont.css">
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="shortcut icon" href="/favicon.ico" >
    <style media="screen">
      nav{
          line-height: 0px;;
      }
      nav .logo{
          padding-top: 15px;;
      }
      nav .zc{
          text-align: right;
          line-height: 0px;
          font-size: 12px;
      }
      nav .zc a{
          cursor: pointer;
          color: #0891fb;
      }
      .register-btn{
        width: 300px;
        margin-left: 131px;
        height: 48px;
        color: #fff;
        font-size: 16px;
        line-height: 48px;
        text-align: center;
        display: inline-block;
        background: #108EE9;
        border-radius: 4px;
      }
      label {
          font-weight: normal;
      }
     b{
        color:#333333;
     }

      .main-body {
        position: absolute;
        top: 46%;
        left: 50%;
        transform: translate(-50%,-50%);
        margin: 0;
      }
    </style>
  </head>
  <body>


    <div class="main-body">
      <div class="logo-box">
      </div>
      <form class=""  id="signup-form" >
        <div class="form-row require">
          <label for="userPhoneNum">手机号：</label>
          <div class="clms-input">
            <span>+86</span>
            <input type="text" id="userPhoneNum" name = "userPhoneNum"  value="" placeholder="请输入11位手机号码"  autocomplete="off">
          </div>
        </div>
        <div class="form-row require">
          <label for="ecode">验证码：</label>
          <div class="clms-input sms-capcha-input"  style="width:160px;">
            <input type="text" name="ecode" value="" id="ecode" placeholder="请输入验证码"  autocomplete="off">
          </div>
          <div class="sms_capcha_btn">
            <button type="button"  id="get-codes-btn" class="inline-btn normal" >
              获取验证码
            </button>
          </div>
          <!-- <p class="tips">若短信验证码获取失败，<a href="javascript:">请获取语音验证码。</a></p> -->
        </div>
        <div class="form-row" style="margin-top:20px;">
            <button class="register-btn" type="submit">
              立即体验
            </button>
          </div>
      </form>
    </div>
    <script src="https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/jquery-validate/1.17.0/jquery.validate.min.js"></script>
    <script src="https://cdn.bootcss.com/jquery-validate/1.17.0/localization/messages_zh.min.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript">
      var countdown = 60;
      function settime(obj) {
          obj = $("#get-codes-btn");
          if (countdown == 0) {
              $("#get-codes-btn").attr("disabled",false)
              obj.html("获取验证码");
              countdown = 60;
              return;
          } else {
              $("#get-codes-btn").attr("disabled",true)
              obj.html("重新发送（" + countdown + ")" );
              countdown--;
          }

      // 发送短信后回调
      setTimeout(function() {
          settime(obj) }
          ,1000)
      }
      /**
       * 获取短信验证码
       */
      $('#get-codes-btn').click(function () {
          if ($("#userPhoneNum").val().length == 11) {
              var form = document.getElementById("signup-form");
              var fd = new FormData(form);

              $.ajax({
                  url : '/account/exsendsmscode',
                  type : 'POST',
                  data : fd,
                  async : false,
                  cache : false,
                  contentType : false,// 告诉jQuery不要去设置Content-Type请求头
                  processData : false,// 告诉jQuery不要去处理发送的数据
                  success : function(data) {
                      if (!data.flag && data.msg!="") {
                          alert(data.msg);
                      } else {
                          settime($(this));
                      }
                  },
                  error : function(data) {
                      console.log(data);
                  }
              });
          }else {
              alert("请填写正确手机号");
          }
      });


      $.validator.setDefaults({
        submitHandler: function() {
            var form = document.getElementById("signup-form");
            var fd = new FormData(form);
            event.preventDefault();
            $(".register-btn").attr("disabled",true);
            $(".register-btn").text("登录中...");
            $.ajax({
                url : '/account/experience',
                type : 'POST',
                data : fd,
                async : false,
                cache : false,
                contentType : false,// 告诉jQuery不要去设置Content-Type请求头
                processData : false,// 告诉jQuery不要去处理发送的数据
                success: function (data) {
                    var data = JSON.parse(data);
                    console.log(data)
                    if (data.code == 0) {
                        if (data.hasOwnProperty("data")) {
                            var dataArray = data.data;
                            if (dataArray.length==0) { //没有企业关系
                                alert("体验账号没有企业，请联系管理员");
                            } else {
                                window.location.href = "/account/logincompany?companyId="+data.data.compId;
                            }
                        }

                    }else{
                        $(".register-btn").attr("disabled",false);
                        $(".register-btn").text("立即体验");
                        alert(data.message);
                    }
                },
                error: function (data) {
                    $(".register-btn").attr("disabled",false);
                    $(".register-btn").text("立即体验");
                    var result = JSON.parse(data);
                    alert(result.message);
                },
            });
        }
      });
      $.validator.addMethod("checkPhone",function(value,element,params){
         var checkPhone = /^1[3|5|4|8|7|9|6]{1}[0-9]{9}$/
         return this.optional(element)||(checkPhone.test(value));
       },"*请输入正确的手机号码！");

      $().ready(function() {
          $("[data-toggle='popover']").popover();
          $("#signup-form").validate({
          rules:{     //配置验证规则，key就是被验证的dom对象，value就是调用验证的方法(也是json格式)
              userPhoneNum:{
                    required:true,  //必填。如果验证方法不需要参数，则配置为true
                    rangelength:[11,11],
                    checkPhone:true,
                },
              ecode:{
                    required:true,
                    rangelength:[4,4],
                }
            },
            messages: {
                userPhoneNum: {
                    required: "请输入手机号",
                    rangelength:'请输入11位手机号码',
                    checkPhone: "请输入正确的手机号码格式",
              },
                ecode:{
                required: "请输入验证码",
                rangelength: "请输入4位验证码",
              }
            }
        });
      });
      </script>
  </body>
</html>
