<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>忘记密码</title>
    <link rel="stylesheet" href="./style.css">
  </head>
  <body>
    <div class="nav-head">
      <nav>
        <div class="logo">
          <img src="./asset/image/logo_top.png" alt="">
          <span class="logo-title">忘记密码</span>
        </div>
        <div class="user-menu">
        </div>
      </nav>
    </div>

    <div class="content">
      <div class="page">
              <div class="signin-box">
                    <div class="">
                        <form class="" action="/checkvalidcode" id="reset-form" method="post">
                          <div class="form-row">
                            <label for="phoneNum">手机号：</label>
                            <div class="clms-input">
                              <span>+86</span>
                              <input type="text" name="phoneNum" id="phoneNumTxt"  placeholder="请输入手机号">
                            </div>
                          </div>
                          <div class="form-row">
                            <label for="captcha">验证码：</label>
                            <div class="clms-input sms-capcha-input">
                              <input type="text" name="validcode"  id="captcha" placeholder="请输入验证码">
                            </div>
                            <div class="sms_capcha_btn">
                              <button type="button"  id="btn" class="inline-btn normal" onclick="sendValidCode(this)" >
                                获取验证码
                              </button>
                            </div>
                          </div>
                          <div class="form-row login-btn-row" style="margin-top:32px;">
                            <button type="button" class="normal" onclick="return check()">
                              下一步
                            </button>
                          </div>
                        </form>
                    </div>
              </div>
        <!-- page xia-->
      </div>
      <!-- contetEnd xia-->
    </div>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/jquery-validate/1.17.0/jquery.validate.min.js"></script>
    <script type="text/javascript" th:inline="javascript">

        $().ready(function(){

            var error = [[${error}]];
            if(error != null && error.length != 0) {
                alert(error);
            }
            //让当前表单调用validate方法，实现表单验证功能

        });

        function validform() {
            return $("#reset-form").validate({
                rules:{     //配置验证规则，key就是被验证的dom对象，value就是调用验证的方法(也是json格式)
                    phoneNum:{
                        required:true,  //必填。如果验证方法不需要参数，则配置为true
                        rangelength:[6,12],
                    },
                    validcode:{
                        required:true,
                        rangelength:[3,5],
                    },
                },
                messages: {
                    phoneNum: {
                        required: "请输入手机号",
                        rangelength: "请输入正确手机号",
                    },
                    validcode:{
                        required: "请输入验证码",
                        rangelength: "请输入4位验证码",
                    }
                }
            })
        }

        var countdown=60;
        function sendValidCode(obj){
            var phoneNum = $("#phoneNumTxt").val()
            var patrn= new RegExp("^((13[0-9])|(17[0-9])|(14[5|7])|(15([0-3]|[5-9]))|(18[0,5-9]))\\d{8}$");
            console.log(patrn.exec(phoneNum));
            if (!patrn.exec(phoneNum)){
                alert("请填写正确手机号")
                return;
            }

         $.post("/sendforgetpwdcode",{"phoneNum":$("#phoneNumTxt").val()},function (data) {
              console.log(data);
              var data = JSON.parse(data);
              if (data.result == false) {
                  alert(data.message);
              }else{
                  settime(obj);
              }
          })
        }

        function check() {
            if(validform().form())
            {
                $.post("/checkcode",{"phoneNum":$("#phoneNumTxt").val(),"validcode":$("#captcha").val()},function (data) {
                    console.log(data);
                    var data = JSON.parse(data);
                    if (data.result == false) {
                        alert(data.message);
                    }else{
                        $("#reset-form").submit();
                    }
                })
            }
        }

        function settime(obj) {
            if (countdown == 0) {
                obj.removeAttribute("disabled");
                obj.innerHTML="重新获取";
                countdown = 60;
                return;
            } else {
                obj.setAttribute("disabled", true);
                obj.innerHTML="重新发送(" + countdown + ")";
                countdown--;
            }

        // 发送短信后回调
        setTimeout(function() {
            settime(obj) }
            ,1000)
        }
        </script>
  </body>
</html>
